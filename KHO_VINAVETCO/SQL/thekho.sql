USE KHO_VINAVETCO

SELECT MATHANG.MAMH,TENMH,KLDVT,DONVITINH,NGAY,MATHANG.MANCC,TENNCC,TONCUOI AS TONTT, TONCUOI-TONCUOI AS CHENHLECH, TONDAU,NHAP,TRANHAP,XUAT,TRAXUAT,TONCUOI,TONDAU*KLDVT AS KLTONDAU,NHAP*KLDVT AS KLNHAP,TRANHAP*KLDVT AS KLTRANHAP,XUAT*KLDVT AS KLXUAT,TRAXUAT*KLDVT AS KLTRAXUAT,TONCUOI*KLDVT AS KLTONCUOI, TONDAU*GIAMUA AS THANHTIENTONDAU, TONCUOI*GIAMUA AS THANHTIENTONCUOI,THANHTIENNHAP AS THANHTIENNHAP,THANHTIENXUAT AS THANHTIENXUAT,THANHTIENTRANHAP AS THANHTIENTRANHAP,THANHTIENTRAXUAT AS THANHTIENTRAXUAT FROM (SELECT MATHANG.MAMH,convert(varchar,GETDATE(),103) AS NGAY,
(SELECT TONDAU FROM TONDAUMATHANG WHERE TONDAUMATHANG.MAMH=MATHANG.MAMH)+(SELECT CASE WHEN SUM(NHAPXUAT) IS NULL THEN 0 ELSE SUM(NHAPXUAT) END FROM TONKHO WHERE TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY < '2013/06/1' ) AS TONDAU,(SELECT CASE WHEN SUM(NHAPXUAT) IS NULL THEN 0 ELSE SUM(NHAPXUAT) END  FROM TONKHO WHERE TONKHO.MANHAPXUAT='N' AND TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY = '2013/06/18') AS NHAP,
(SELECT CASE WHEN SUM(GIATIEN) IS NULL THEN 0 ELSE SUM(GIATIEN) END  FROM TONKHO WHERE TONKHO.MANHAPXUAT='N' AND TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY ='2013/06/18') AS THANHTIENNHAP,(SELECT CASE WHEN SUM(NHAPXUAT) IS NULL THEN 0 ELSE -SUM(NHAPXUAT) END  FROM TONKHO WHERE TONKHO.MANHAPXUAT='X' AND TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY ='2013/06/18') AS XUAT,
(SELECT CASE WHEN SUM(GIATIEN) IS NULL THEN 0 ELSE SUM(GIATIEN) END  FROM TONKHO WHERE TONKHO.MANHAPXUAT='X' AND TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY ='2013/06/18') AS THANHTIENXUAT,(SELECT CASE WHEN SUM(NHAPXUAT) IS NULL THEN 0 ELSE -SUM(NHAPXUAT) END  FROM TONKHO WHERE TONKHO.MANHAPXUAT='TN' AND TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY ='2013/06/18') AS TRANHAP,
(SELECT CASE WHEN SUM(GIATIEN) IS NULL THEN 0 ELSE SUM(GIATIEN) END  FROM TONKHO WHERE TONKHO.MANHAPXUAT='TN' AND TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY ='2013/06/18') AS THANHTIENTRANHAP,(SELECT CASE WHEN SUM(NHAPXUAT) IS NULL THEN 0 ELSE SUM(NHAPXUAT) END  FROM TONKHO WHERE TONKHO.MANHAPXUAT='TX' AND TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY ='2013/06/18') AS TRAXUAT,
(SELECT CASE WHEN SUM(GIATIEN) IS NULL THEN 0 ELSE SUM(GIATIEN) END  FROM TONKHO WHERE TONKHO.MANHAPXUAT='TX' AND TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY ='2013/06/18') AS THANHTIENTRAXUAT,(SELECT TONDAU FROM TONDAUMATHANG WHERE TONDAUMATHANG.MAMH=MATHANG.MAMH)+(SELECT CASE WHEN SUM(NHAPXUAT) IS NULL THEN 0 ELSE SUM(NHAPXUAT) END FROM TONKHO WHERE TONKHO.MAMH=MATHANG.MAMH AND TONKHO.NGAY <= '2013/06/18' ) AS TONCUOI 
FROM MATHANG) AS T1, MATHANG, NHACUNGCAP,DONVITINH WHERE MATHANG.MAMH=T1.MAMH AND NHACUNGCAP.MANCC=MATHANG.MANCC AND DONVITINH.MADVT=MATHANG.MADVT 
